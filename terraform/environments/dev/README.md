# k8sAtlas Development Environment

This directory contains Terraform configuration for the k8sAtlas development GKE cluster.

## Architecture

This configuration creates:

- **VPC Network**: Custom VPC with subnets for nodes, pods, and services
- **Private GKE Cluster**: Regional cluster with no public node IPs
- **Cloud NAT**: Allows private nodes to access the internet
- **Node Pools**:
  - **System Pool**: For platform services (ingress, monitoring)
  - **Workload Pool**: For application workloads
- **Workload Identity**: Secure authentication for pods to access GCP services
- **Network Policies**: Calico network policy enforcement

## Prerequisites

Before running Terraform, ensure you have:

1. Completed Phase 0 (Bootstrap) - `make bootstrap`
2. Terraform installed - `terraform version`
3. gcloud authenticated - `gcloud auth application-default login`
4. Correct GCP project set - `gcloud config set project sshabanov`

## Quick Start

### 1. Create terraform.tfvars

```bash
# Copy the example file
cp terraform.tfvars.example terraform.tfvars

**Important**: Update at minimum:
- `project_id` - Your GCP project ID
- `master_authorized_networks` - Your IP for kubectl access (if using private endpoint)

### 2. Initialize Terraform

```bash
# From project root
make init

# Or directly
terraform init
```

This will:
- Download required providers (google, google-beta)
- Download official Google Cloud modules
- Configure GCS backend for state storage

### 3. Review the Plan

```bash
# From project root
make plan

# Or directly
terraform plan
```

Review the resources that will be created. Expected resources: ~20-30

### 4. Apply the Configuration

```bash
# From project root
make apply

# Or directly
terraform apply
```

**This will create real GCP resources and incur costs!**

Expected creation time: 10-15 minutes

### 5. Configure kubectl

```bash
# From project root
make kubeconfig

# Or directly
gcloud container clusters get-credentials k8satlas-gke-dev \
  --region europe-west4 \
  --project sshabanov
```

### 6. Verify the Cluster

```bash
# Check nodes
kubectl get nodes

# Check system pods
kubectl get pods --all-namespaces

# Get cluster info
kubectl cluster-info
```

## Files in This Directory

| File | Purpose |
|------|---------|
| `backend.tf` | GCS backend configuration (generated by bootstrap) |
| `versions.tf` | Terraform and provider version constraints |
| `variables.tf` | Input variable definitions |
| `main.tf` | Main infrastructure resources |
| `outputs.tf` | Output values after deployment |
| `terraform.tfvars.example` | Example variable values |
| `terraform.tfvars` | Actual values (NOT committed to Git) |


## Terraform State

State is stored in GCS:
- **Bucket**: `k8satlas-tfstate`
- **Prefix**: `terraform/state/dev`

**Never commit `.tfstate` files to Git!**

**To avoid charges, destroy resources when not in use:**
```bash
make destroy
```

Set up billing alerts: https://console.cloud.google.com/billing

## Support

- [GKE Documentation](https://cloud.google.com/kubernetes-engine/docs)
- [Terraform GKE Module](https://github.com/terraform-google-modules/terraform-google-kubernetes-engine)
- [Terraform VPC Module](https://github.com/terraform-google-modules/terraform-google-network)
